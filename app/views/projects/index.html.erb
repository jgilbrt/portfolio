<div class="container-fluid py-4 mt-4" style="max-width:100%;overflow-x:visible;">
  <div class="d-flex justify-content-center mb-3">
    <button id="toggle-projects-btn" class="btn btn-outline-secondary fw-bold text-uppercase px-2 py-1 rounded-2 border-3" aria-expanded="true" aria-controls="projects-container" style="font-size:.8rem;">Hide Projects</button>
  </div>
  <div id="projects-container" tabindex="0" aria-label="Project cards container">
    <div class="d-flex justify-content-center flex-wrap mb-3 gap-2" role="group" aria-label="Filter projects by type">
      <input type="radio" class="btn-check" name="project-filter" id="filter-all" autocomplete="off" checked data-filter="all">
      <label class="btn btn-outline-info fw-bold text-uppercase px-2 py-1 rounded-2 border-3" for="filter-all" style="font-size:.8rem;">ALL</label>

      <input type="radio" class="btn-check" name="project-filter" id="filter-web-dev" autocomplete="off" data-filter="web_dev">
      <label class="btn btn-outline-success fw-bold text-uppercase px-2 py-1 rounded-2 border-3" for="filter-web-dev" style="font-size:.8rem;">WEB DEV</label>

      <input type="radio" class="btn-check" name="project-filter" id="filter-ux-design" autocomplete="off" data-filter="ux_design">
      <label class="btn btn-outline-primary fw-bold text-uppercase px-2 py-1 rounded-2 border-3" for="filter-ux-design" style="font-size:.8rem;">UX DESIGN</label>
    </div>

    <div class="px-2 pt-4 pb-3 hide-scrollbar" style="overflow-x:auto; -webkit-overflow-scrolling:touch;">
      <div class="d-flex flex-nowrap gap-3 p-2">
        <% @projects.each do |project| %>
          <div class="flex-shrink-0 project-card-item"
               data-project-id="<%= project[:id] %>" data-name="<%= project[:name] %>" data-description="<%= project[:description] %>"
               data-image-url="<%= project[:image_url] %>" data-type="<%= project[:type].parameterize(separator: '_') %>"
               style="width:280px;border-radius:16px;background:#fff;box-shadow:0 3px 9px rgb(0 0 0 / 0.2);cursor:pointer;transition:transform .3s ease,box-shadow .3s ease,border-color .3s ease;display:flex;flex-direction:column;position:relative;margin-bottom:1rem;">
            <div class="position-absolute top-0 start-0 m-3 px-2 py-1 rounded-2 fw-bold text-uppercase"
                 style="font-size:.8rem;background-color:rgba(255,255,255,.9);z-index:10;
                 <% if project[:type].parameterize(separator: '_') == 'web_dev' %> border:3px solid #28a745;color:#28a745;
                 <% elsif project[:type].parameterize(separator: '_') == 'ux_design' %> border:3px solid #007bff;color:#007bff;
                 <% end %>">
              <%= project[:type] %>
            </div>
            <img src="<%= project[:image_url] %>" alt="<%= project[:name] %>" class="img-fluid" style="height:180px;object-fit:cover;border-top-left-radius:12px;border-top-right-radius:12px;width:100%;flex-shrink:0;" />
            <div class="p-3 d-flex flex-column justify-content-center flex-grow-1">
              <h6 class="mb-1 fw-bold text-dark" style="font-size:1.1rem;"><%= project[:name] %></h6>
              <p class="mb-0 text-secondary" style="font-size:.9rem;line-height:1.3;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"><%= project[:description] %></p>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  <div id="selected-project-detail" class="mt-4" tabindex="0" aria-live="polite" aria-atomic="true">
    <h3 class="text-center text-muted">[ SELECT A PROJECT ]</h3>
  </div>
</div>
<button id="back-to-top-btn" class="btn btn-secondary btn-sm position-fixed rounded-circle shadow"
        style="bottom:30px;right:30px;z-index:1100;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-family:'Source Code Pro',monospace;">â†‘</button>

<script>
  function initProjectPage() {
    const backToTopBtn = document.getElementById('back-to-top-btn');
    const projectsContainer = document.getElementById('projects-container');
    const detailDiv = document.getElementById("selected-project-detail");
    const toggleBtn = document.getElementById('toggle-projects-btn');
    const filterButtons = document.querySelectorAll('input[name="project-filter"]');
    const projectCards = document.querySelectorAll('.project-card-item');

    const applyHoverEffects = (card) => {
      card.onmouseover = () => { card.style.transform = 'translateY(-8px)'; card.style.boxShadow = '0 8px 16px rgba(0,0,0,0.15)'; };
      card.onmouseout = () => { if (!card.style.border || !card.style.border.includes('gold')) { card.style.transform = ''; card.style.boxShadow = '0 3px 9px rgba(0,0,0,0.2)'; } };
    };
    const removeHoverEffects = (card) => { card.onmouseover = null; card.onmouseout = null; };

    projectCards.forEach(applyHoverEffects);
    if (backToTopBtn) backToTopBtn.onclick = () => window.scrollTo({top:0,behavior:'smooth'});

    if (projectsContainer) {
      projectsContainer.onclick = (e) => {
        const card = e.target.closest('.project-card-item'); if (!card) return;
        projectCards.forEach(c => {
          c.style.border = ''; c.style.boxShadow = '0 3px 9px rgba(0,0,0,0.2)';
          const selText = c.querySelector('.selected-label'); if (selText) selText.remove();
          applyHoverEffects(c);
        });
        card.style.border = '3px solid gold'; card.style.boxShadow = '0 0 8px 3px gold'; removeHoverEffects(card);
        const selLabel = document.createElement('span');
        selLabel.textContent = 'SELECTED'; selLabel.className = 'selected-label position-absolute rounded-1 fw-bold text-dark';
        // Adjust style to prevent clipping and ensure it's on top of the border
        selLabel.style.cssText = 'top:-14px; right:12px; background-color:gold; font-size:.75rem; padding:2px 6px; z-index:20; user-select:none; pointer-events:none; border: 2px solid gold;';
        card.appendChild(selLabel);
        const projName = card.getAttribute("data-name").toLowerCase().replace(/\s+/g,'');
        fetch(`/projects/partial/${projName}`).then(res => {
          if (!res.ok) { console.error(`Partial for ${projName} not found.`); detailDiv.innerHTML = `<h4 class="text-center text-danger mt-4">Details not available.</h4>`; throw new Error("Partial not found"); }
          return res.text();
        }).then(html => {
          detailDiv.innerHTML = html;
          // Adjust scrollIntoView to account for fixed navbar height and the label
          const yOffset = - (mainNavbar.offsetHeight + 20); // mainNavbar height + some extra padding
          const y = detailDiv.getBoundingClientRect().top + window.pageYOffset + yOffset;
          window.scrollTo({top: y, behavior: 'smooth'});
        }).catch(err => { console.error("Error fetching partial:", err); });
      };
    }

    if (toggleBtn && projectsContainer) {
      toggleBtn.onclick = () => {
        const isHidden = projectsContainer.classList.toggle('d-none');
        toggleBtn.textContent = isHidden ? "Show Projects" : "Hide Projects";
        toggleBtn.setAttribute('aria-expanded', !isHidden);
        if (!isHidden) projectsContainer.focus();
      };
    }

    filterButtons.forEach(button => {
      button.addEventListener('change', (e) => {
        const filterType = e.target.dataset.filter;
        projectCards.forEach(card => {
          const cardType = card.dataset.type;
          card.classList.toggle('d-none', !(filterType === 'all' || cardType === filterType));
        });
        const scrollInner = projectsContainer.querySelector('div[style*="overflow-x:auto"]');
        if (scrollInner) scrollInner.scrollLeft = 0;
      });
    });

    const allFilterBtn = document.getElementById('filter-all');
    if (allFilterBtn) { allFilterBtn.checked = true; allFilterBtn.dispatchEvent(new Event('change')); }
  }
  document.addEventListener('DOMContentLoaded', initProjectPage);
  document.addEventListener('turbo:load', initProjectPage);
</script>
